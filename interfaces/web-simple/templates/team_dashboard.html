<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#2c5aa0" />
    <title>{{ team.name }} - NUAA Tools</title>

    <!-- Fluent UI Web Components -->
    <script type="module" src="https://unpkg.com/@fluentui/web-components@2.6.1"></script>

    <link rel="stylesheet" href="/static/css/main.css" />
    <link rel="stylesheet" href="/static/css/dashboard.css" />
    <link rel="stylesheet" href="/static/css/themes.css" />
    <link rel="stylesheet" href="/static/css/fluent-theme.css" />
  </head>
  <body>
    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="nav-container">
        <a href="/" class="nav-brand">
          <span class="nav-icon">ğŸ </span>
          <span>NUAA Tools</span>
        </a>
        <div class="nav-team">
          <span class="team-icon">{{ team.icon }}</span>
          <span class="team-name">{{ team.name }}</span>
        </div>
        <div class="nav-actions">
          <fluent-button
            appearance="stealth"
            class="btn-icon"
            onclick="toggleSearch()"
            aria-label="Search documents"
          >
            ğŸ”
          </fluent-button>
          <fluent-button
            appearance="stealth"
            class="btn-icon"
            onclick="window.location.href='/analytics'"
            aria-label="Analytics"
          >
            ğŸ“Š
          </fluent-button>
          <fluent-button
            appearance="stealth"
            class="btn-icon"
            onclick="window.location.href='/admin'"
            aria-label="Admin"
          >
            ğŸ”§
          </fluent-button>
          <fluent-button
            appearance="stealth"
            class="btn-icon"
            onclick="toggleNotifications()"
            aria-label="Notifications"
            style="position: relative;"
          >
            ğŸ””
            <fluent-badge
              id="notificationBadge"
              appearance="filled"
              color="danger"
              style="display: none; position: absolute; top: -5px; right: -5px;"
              >0</fluent-badge
            >
          </fluent-button>
          <fluent-button
            appearance="stealth"
            class="btn-icon"
            onclick="window.location.href='/accessibility'"
            aria-label="Accessibility settings"
          >
            â™¿
          </fluent-button>
        </div>
      </div>
    </nav>

    <!-- Search Overlay -->
    <div id="searchOverlay" class="search-overlay" style="display: none">
      <div class="search-container">
        <fluent-text-field
          type="text"
          id="searchInput"
          placeholder="Search documents, templates, or team resources..."
          class="search-input"
          onkeyup="performSearch(event)"
          style="width: 100%;"
        ></fluent-text-field>
        <fluent-button
          appearance="stealth"
          onclick="toggleSearch()"
          class="search-close"
          aria-label="Close search"
        >
          âœ•
        </fluent-button>
        <div id="searchResults" class="search-results"></div>
      </div>
    </div>

    <div class="dashboard-container">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-section">
          <h3>Quick Actions</h3>
          <fluent-button class="action-btn" appearance="accent" onclick="showQuickReport()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">âš¡</span>
            <span>Quick Report</span>
          </fluent-button>
          <fluent-button class="action-btn" appearance="neutral" onclick="showRecentDocuments()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">ğŸ“„</span>
            <span>Recent Documents</span>
          </fluent-button>
          <fluent-button class="action-btn" appearance="neutral" onclick="showDrafts()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">ğŸ’¾</span>
            <span>Saved Drafts</span>
          </fluent-button>
        </div>

        <div class="sidebar-section">
          <h3>Tools</h3>
          <fluent-button class="action-btn" appearance="neutral" onclick="exportDocuments()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">ğŸ“¤</span>
            <span>Export</span>
          </fluent-button>
          <fluent-button class="action-btn" appearance="neutral" onclick="showStatistics()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">ğŸ“Š</span>
            <span>Statistics</span>
          </fluent-button>
          <fluent-button
            class="action-btn"
            appearance="neutral"
            onclick="window.location.href='/help/{{ team_id }}'"
            style="width: 100%; justify-content: flex-start;"
          >
            <span class="btn-icon">â“</span>
            <span>Help & Support</span>
          </fluent-button>
        </div>

        <div class="sidebar-section">
          <h3>Integrations</h3>
          <fluent-button class="action-btn" appearance="neutral" onclick="shareToTeams()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">ğŸ‘¥</span>
            <span>Share to Teams</span>
          </fluent-button>
          <fluent-button class="action-btn" appearance="neutral" onclick="sendEmail()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">ğŸ“§</span>
            <span>Email Report</span>
          </fluent-button>
          <fluent-button class="action-btn" appearance="neutral" onclick="syncSharePoint()" style="width: 100%; justify-content: flex-start;">
            <span class="btn-icon">â˜ï¸</span>
            <span>Sync SharePoint</span>
          </fluent-button>
        </div>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Welcome Banner -->
        <div class="welcome-banner">
          <h1>Welcome to {{ team.name }}</h1>
          <p>{{ team.description }}</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
          <fluent-card class="stat-card">
            <div class="stat-icon">ğŸ“</div>
            <div class="stat-info">
              <div class="stat-value" id="totalDocs">0</div>
              <div class="stat-label">Total Documents</div>
            </div>
          </fluent-card>
          <fluent-card class="stat-card">
            <div class="stat-icon">ğŸ•</div>
            <div class="stat-info">
              <div class="stat-value" id="recentDocs">0</div>
              <div class="stat-label">This Week</div>
            </div>
          </fluent-card>
          <fluent-card class="stat-card">
            <div class="stat-icon">ğŸ’¾</div>
            <div class="stat-info">
              <div class="stat-value" id="draftCount">0</div>
              <div class="stat-label">Saved Drafts</div>
            </div>
          </fluent-card>
          <fluent-card class="stat-card">
            <div class="stat-icon">â­</div>
            <div class="stat-info">
              <div class="stat-value" id="templateCount">
                {{ team.templates|length }}
              </div>
              <div class="stat-label">Templates</div>
            </div>
          </fluent-card>
        </div>

        <!-- Templates Section -->
        <section class="templates-section">
          <div class="section-header">
            <h2>Your Templates</h2>
            <div class="view-toggle">
              <button
                class="toggle-btn active"
                data-view="grid"
                onclick="switchView('grid')"
              >
                <span>â–¦</span>
              </button>
              <button
                class="toggle-btn"
                data-view="list"
                onclick="switchView('list')"
              >
                <span>â˜°</span>
              </button>
            </div>
          </div>

          <div class="templates-grid" id="templatesContainer">
            {% for template in team.templates %}
            <fluent-card
              class="template-card"
              onclick="window.location.href='/template/{{ team_id }}/{{ template }}'"
              style="cursor: pointer;"
            >
              <div class="template-header">
                <span class="template-icon">ğŸ“‹</span>
                <div class="template-actions">
                  <fluent-button
                    appearance="stealth"
                    class="btn-icon-small"
                    onclick="event.stopPropagation(); favoriteTemplate('{{ template }}')"
                    aria-label="Favorite"
                  >
                    â­
                  </fluent-button>
                  <fluent-button
                    appearance="stealth"
                    class="btn-icon-small"
                    onclick="event.stopPropagation(); shareTemplate('{{ template }}')"
                    aria-label="Share"
                  >
                    ğŸ“¤
                  </fluent-button>
                </div>
              </div>
              <h3 class="template-name">
                {{ template.replace('.md', '').replace('-', ' ').title() }}
              </h3>
              <p class="template-description">
                Create a {{ template.replace('.md', '').replace('-', ' ') }}
              </p>
              <div class="template-meta">
                <fluent-badge appearance="lightweight">Template</fluent-badge>
                <span class="template-usage" id="usage-{{ template }}"
                  >Used 0 times</span
                >
              </div>
            </fluent-card>
            {% endfor %}
          </div>
        </section>

        <!-- Recent Documents Section -->
        <section class="recent-section">
          <div class="section-header">
            <h2>Recent Documents</h2>
            <button class="btn-link" onclick="showAllDocuments()">
              View All â†’
            </button>
          </div>
          <div class="documents-list" id="recentDocuments">
            <div class="empty-state">
              <span class="empty-icon">ğŸ“</span>
              <p>
                No documents yet. Create your first document using a template
                above!
              </p>
            </div>
          </div>
        </section>

        <!-- Activity Timeline -->
        <section class="activity-section">
          <div class="section-header">
            <h2>Recent Activity</h2>
          </div>
          <div class="activity-timeline" id="activityTimeline">
            <div class="timeline-item">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <p class="timeline-text">Welcome to your dashboard!</p>
                <span class="timeline-time">Just now</span>
              </div>
            </div>
          </div>
        </section>
      </main>
    </div>

    <!-- Quick Report Modal -->
    <fluent-dialog id="quickReportModal" modal style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Quick Report</h2>
          <fluent-button appearance="stealth" class="modal-close" onclick="closeQuickReport()">
            &times;
          </fluent-button>
        </div>
        <div class="modal-body">
          <fluent-text-area
            id="quickReportText"
            placeholder="Type your quick report here... No formatting needed, just the facts!"
            rows="8"
            class="quick-report-textarea"
            style="width: 100%;"
          ></fluent-text-area>
          <div class="form-group">
            <label>
              <fluent-checkbox id="addPhoto"></fluent-checkbox>
              Add Photo
            </label>
            <input
              type="file"
              id="photoUpload"
              accept="image/*"
              capture="environment"
              style="display: none"
            />
          </div>
          <div class="form-group">
            <label>
              <fluent-checkbox id="addLocation"></fluent-checkbox>
              Add Location
            </label>
            <span id="locationStatus"></span>
          </div>
        </div>
        <div class="modal-footer">
          <fluent-button appearance="neutral" onclick="saveDraft()">
            ğŸ’¾ Save Draft
          </fluent-button>
          <fluent-button appearance="accent" onclick="submitQuickReport()">
            ğŸ“¤ Submit
          </fluent-button>
        </div>
      </div>
    </fluent-dialog>

    <!-- Notification Panel -->
    <div
      id="notificationPanel"
      class="notification-panel"
      style="display: none"
    >
      <div class="panel-header">
        <h3>Notifications</h3>
        <button onclick="toggleNotifications()" class="btn-close">âœ•</button>
      </div>
      <div class="panel-content">
        <div class="notification-item">
          <span class="notification-icon">ğŸ“</span>
          <div class="notification-text">
            <p>Welcome to {{ team.name }}!</p>
            <span class="notification-time">Just now</span>
          </div>
        </div>
      </div>
    </div>

    <script src="/static/js/dashboard.js"></script>
    <script>
      // Initialize dashboard data
      const teamId = "{{ team_id }}";
      const teamName = "{{ team.name }}";

      // Load statistics and recent documents
      document.addEventListener("DOMContentLoaded", function () {
        loadDashboardStats();
        loadRecentDocuments();
        loadActivityTimeline();
        checkForDrafts();
      });

      function loadDashboardStats() {
        // Fetch stats from API
        fetch(`/api/stats/${teamId}`)
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("totalDocs").textContent = data.total || 0;
            document.getElementById("recentDocs").textContent =
              data.recent || 0;
            document.getElementById("draftCount").textContent =
              data.drafts || 0;
          })
          .catch((err) => console.log("Stats will load when available"));
      }

      function loadRecentDocuments() {
        fetch(`/api/documents/${teamId}?limit=5`)
          .then((response) => response.json())
          .then((data) => {
            const container = document.getElementById("recentDocuments");
            if (data.documents && data.documents.length > 0) {
              container.innerHTML = data.documents
                .map(
                  (doc) => `
                            <div class="document-item">
                                <span class="doc-icon">ğŸ“„</span>
                                <div class="doc-info">
                                    <h4>${doc.name}</h4>
                                    <span class="doc-date">${doc.date}</span>
                                </div>
                                <div class="doc-actions">
                                    <button onclick="viewDocument('${doc.id}')">View</button>
                                    <button onclick="exportDocument('${doc.id}')">Export</button>
                                </div>
                            </div>
                        `
                )
                .join("");
            }
          })
          .catch((err) => console.log("Documents will load when available"));
      }

      function loadActivityTimeline() {
        // Activity timeline will be populated from API
      }

      function checkForDrafts() {
        const drafts = JSON.parse(
          localStorage.getItem(`drafts_${teamId}`) || "[]"
        );
        if (drafts.length > 0) {
          document.getElementById("draftCount").textContent = drafts.length;
        }
      }

      function showQuickReport() {
        document.getElementById("quickReportModal").style.display = "flex";
      }

      function closeQuickReport() {
        document.getElementById("quickReportModal").style.display = "none";
      }

      function submitQuickReport() {
        const text = document.getElementById("quickReportText").value;
        if (!text.trim()) {
          alert("Please enter some content for your report");
          return;
        }

        const data = {
          team_id: teamId,
          data: text,
          timestamp: new Date().toISOString(),
        };

        fetch("/quick-submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.success) {
              alert("âœ… Quick report submitted successfully!");
              closeQuickReport();
              document.getElementById("quickReportText").value = "";
              loadDashboardStats();
              loadRecentDocuments();
            }
          })
          .catch((error) => {
            alert("Error submitting report. Please try again.");
            console.error(error);
          });
      }

      function saveDraft() {
        const text = document.getElementById("quickReportText").value;
        if (!text.trim()) return;

        const drafts = JSON.parse(
          localStorage.getItem(`drafts_${teamId}`) || "[]"
        );
        drafts.push({
          id: Date.now(),
          content: text,
          date: new Date().toISOString(),
          type: "quick-report",
        });
        localStorage.setItem(`drafts_${teamId}`, JSON.stringify(drafts));

        alert("ğŸ’¾ Draft saved!");
        closeQuickReport();
        checkForDrafts();
      }

      function toggleSearch() {
        const overlay = document.getElementById("searchOverlay");
        overlay.style.display =
          overlay.style.display === "none" ? "block" : "none";
        if (overlay.style.display === "block") {
          document.getElementById("searchInput").focus();
        }
      }

      function toggleNotifications() {
        const panel = document.getElementById("notificationPanel");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
      }

      function performSearch(event) {
        const query = event.target.value.toLowerCase();
        // Search functionality will be enhanced
        console.log("Searching for:", query);
      }

      function switchView(view) {
        document.querySelectorAll(".toggle-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        document.querySelector(`[data-view="${view}"]`).classList.add("active");

        const container = document.getElementById("templatesContainer");
        if (view === "list") {
          container.classList.add("list-view");
        } else {
          container.classList.remove("list-view");
        }
      }

      function showDrafts() {
        const drafts = JSON.parse(
          localStorage.getItem(`drafts_${teamId}`) || "[]"
        );
        if (drafts.length === 0) {
          alert("No saved drafts");
          return;
        }
        // Show drafts modal
        console.log("Drafts:", drafts);
      }

      function exportDocuments() {
        alert(
          "Export functionality coming soon! You'll be able to export as PDF, Word, or Excel."
        );
      }

      function showStatistics() {
        alert("Statistics dashboard coming soon!");
      }

      function shareToTeams() {
        alert("Microsoft Teams integration coming soon!");
      }

      function sendEmail() {
        alert("Email integration coming soon!");
      }

      function syncSharePoint() {
        alert("SharePoint sync coming soon!");
      }

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        if (e.ctrlKey || e.metaKey) {
          if (e.key === "k") {
            e.preventDefault();
            toggleSearch();
          } else if (e.key === "q") {
            e.preventDefault();
            showQuickReport();
          }
        }
        if (e.key === "Escape") {
          closeQuickReport();
          document.getElementById("searchOverlay").style.display = "none";
          document.getElementById("notificationPanel").style.display = "none";
        }
      });

      // Check for photo upload
      document
        .getElementById("addPhoto")
        .addEventListener("change", function (e) {
          if (e.target.checked) {
            document.getElementById("photoUpload").click();
          }
        });

      // Get location if requested
      document
        .getElementById("addLocation")
        .addEventListener("change", function (e) {
          if (e.target.checked) {
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                (position) => {
                  document.getElementById(
                    "locationStatus"
                  ).textContent = `âœ“ Location captured (${position.coords.latitude.toFixed(
                    4
                  )}, ${position.coords.longitude.toFixed(4)})`;
                },
                (error) => {
                  document.getElementById("locationStatus").textContent =
                    "âœ— Unable to get location";
                  e.target.checked = false;
                }
              );
            } else {
              alert("Geolocation is not supported by your browser");
              e.target.checked = false;
            }
          } else {
            document.getElementById("locationStatus").textContent = "";
          }
        });
    </script>

    <!-- Advanced Features Integration -->
    <script src="/static/js/theme-switcher.js"></script>
    <script src="/static/js/version-history.js"></script>
    <script src="/static/js/keyboard-shortcuts.js"></script>
  </body>
</html>
