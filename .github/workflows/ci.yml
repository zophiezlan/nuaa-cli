name: CI

on:
    push:
    pull_request:

jobs:
    tests:
        name: Lint and test (Python ${{ matrix.python-version }} â€¢ ${{ matrix.os }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                os: [ubuntu-latest, windows-latest]
                python-version: ["3.11", "3.12", "3.13"]

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: "pip"
                  cache-dependency-path: |
                      pyproject.toml

            - name: Upgrade pip
              run: python -m pip install --upgrade pip

            - name: Install package (with dev deps)
              run: pip install -e .[dev]

            - name: Lint (ruff)
              run: ruff check .

            - name: Type check (mypy)
              run: mypy .
              continue-on-error: true

            - name: Pre-commit (format and basic checks)
              run: pre-commit run --all-files --show-diff-on-failure

            - name: Verify agent docs are up-to-date
              shell: bash
              run: |
                  python scripts/python/update_agents_docs.py
                  if ! git diff --quiet -- README.md AGENTS.md; then
                    echo "Agent docs are out of date. Run scripts/python/update_agents_docs.py and commit changes." >&2
                    git --no-pager diff README.md AGENTS.md
                    exit 1
                  fi

            - name: Verify agent script parity
              shell: bash
              run: |
                  python scripts/python/verify_agent_script_parity.py

            - name: Run tests (pytest)
              run: pytest -q
