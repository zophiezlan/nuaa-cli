name: Auto-fix Linting Issues

on:
    pull_request:
        types: [opened, synchronize, reopened]

permissions:
    contents: write
    pull-requests: write

jobs:
    auto-fix:
        name: Auto-fix linting issues
        runs-on: ubuntu-latest
        # Only run on PRs from the same repository (not forks)
        if: github.event.pull_request.head.repo.full_name == github.repository

        steps:
            - name: Checkout PR branch
              uses: actions/checkout@v4
              with:
                  ref: ${{ github.head_ref }}
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"
                  cache: "pip"
                  cache-dependency-path: pyproject.toml

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -e .[dev]

            - name: Run auto-fixers
              id: autofix
              run: |
                  echo "Running auto-fixers..."

                  # Run black formatter
                  echo "::group::Black formatter"
                  black src/nuaa_cli tests scripts/python || true
                  echo "::endgroup::"

                  # Run ruff with auto-fix
                  echo "::group::Ruff auto-fix"
                  ruff check --fix src/nuaa_cli tests scripts/python || true
                  echo "::endgroup::"

                  # Run pre-commit hooks
                  echo "::group::Pre-commit hooks"
                  pre-commit run --all-files || true
                  echo "::endgroup::"

                  # Update agent docs if needed
                  echo "::group::Update agent docs"
                  python scripts/python/update_agents_docs.py || true
                  echo "::endgroup::"

            - name: Check for changes
              id: check_changes
              run: |
                  if git diff --quiet; then
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "No changes made by auto-fixers"
                  else
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "Changes detected:"
                    git --no-pager diff --stat
                  fi

            - name: Commit and push fixes
              if: steps.check_changes.outputs.changes == 'true'
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add -A
                  git commit -m "ðŸ¤– Auto-fix: Apply linting and formatting fixes

                  Applied fixes:
                  - black formatting
                  - ruff auto-fixes
                  - pre-commit hooks
                  - agent docs updates

                  [skip ci]"
                  git push

            - name: Report results
              if: steps.check_changes.outputs.changes == 'true'
              run: |
                  echo "âœ… Auto-fixes applied and committed"
                  echo ""
                  echo "The following fixes were applied:"
                  git --no-pager show --stat HEAD

            - name: No changes needed
              if: steps.check_changes.outputs.changes == 'false'
              run: |
                  echo "âœ… No auto-fixes needed - code is already compliant"
